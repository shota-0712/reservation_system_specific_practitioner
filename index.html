<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>En Salon Reservation</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            enji: {
              DEFAULT: '#9b1c2c',
              light: '#b92b3d',
              dark: '#7a1522',
            },
          },
          fontFamily: {
            sans: ['"Helvetica Neue"', 'Arial', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .pb-safe {
      padding-bottom: env(safe-area-inset-bottom);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    /* Hide scrollbar for clean UI */
    ::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 select-none">

  <!-- App Container -->
  <div id="app" class="min-h-screen pb-24">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
      <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-center">
        <img src="logo.png" alt="En Salon" class="h-10 w-auto">
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4">

      <!-- HOME VIEW -->
      <div id="home-view" class="block">

        <!-- Step 1: Menu Selection -->
        <div id="step-menu" class="animate-fade-in">
          <h2 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-enji pl-3">メニュー選択</h2>
          <div id="menu-list" class="space-y-4">
            <div class="animate-pulse space-y-4">
              <div class="h-24 bg-gray-200 rounded-lg"></div>
              <div class="h-24 bg-gray-200 rounded-lg"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: Date Selection -->
        <div id="step-date" class="hidden animate-fade-in">
          <button onclick="goBack('step-menu')" class="btn-ghost mb-2 text-gray-500 text-sm flex items-center gap-1">
            <i class="fas fa-arrow-left"></i> 戻る
          </button>
          <h2 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-enji pl-3">日時選択</h2>

          <!-- Custom Calendar -->
          <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
              <button id="prev-month" class="p-2 text-enji hover:bg-red-50 rounded-full">❮</button>
              <h3 id="calendar-title" class="font-bold text-lg text-gray-700"></h3>
              <button id="next-month" class="p-2 text-enji hover:bg-red-50 rounded-full">❯</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-2">
              <div>日</div>
              <div>月</div>
              <div>火</div>
              <div>水</div>
              <div>木</div>
              <div>金</div>
              <div>土</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
          </div>

          <!-- Time Slots -->
          <div id="time-slots-container" class="hidden">
            <h3 class="font-bold text-gray-700 mb-2">時間を選択</h3>
            <div id="time-slots" class="grid grid-cols-3 gap-2"></div>
          </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div id="step-confirm" class="hidden animate-fade-in">
          <button onclick="goBack('step-date')" class="btn-ghost mb-2 text-gray-500 text-sm flex items-center gap-1">
            <i class="fas fa-arrow-left"></i> 戻る
          </button>
          <h2 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-enji pl-3">予約確認</h2>

          <div class="bg-white shadow-lg border border-gray-100 rounded-xl overflow-hidden">
            <div class="bg-enji text-white p-4">
              <h3 class="font-bold text-lg">ご予約内容</h3>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-xs text-gray-400 block">メニュー</label>
                <p id="confirm-menu" class="font-bold text-gray-800 text-lg"></p>
              </div>
              <div class="flex gap-4">
                <div>
                  <label class="text-xs text-gray-400 block">日付</label>
                  <p id="confirm-date" class="font-bold text-gray-800"></p>
                </div>
                <div>
                  <label class="text-xs text-gray-400 block">時間</label>
                  <p id="confirm-time" class="font-bold text-gray-800"></p>
                </div>
              </div>
              <div>
                <label class="text-xs text-gray-400 block">お名前</label>
                <input type="text" id="user-name-input"
                  class="w-full mt-1 p-2 border border-gray-300 rounded focus:outline-none focus:border-enji focus:ring-1 focus:ring-enji"
                  placeholder="お名前を入力">
              </div>
            </div>
            <div class="p-4 bg-gray-50">
              <button onclick="submitReservation()"
                class="w-full bg-enji hover:bg-enji-dark text-white font-bold py-3 rounded-lg shadow-md transition-colors">予約を確定する</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MY PAGE VIEW -->
      <div id="mypage-view" class="hidden animate-fade-in">
        <h2 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-enji pl-3">マイページ</h2>

        <div class="bg-white rounded-xl shadow-sm p-6 text-center mb-6">
          <div class="mb-2 flex justify-center">
            <div
              class="bg-gray-100 text-gray-400 rounded-full w-16 h-16 flex items-center justify-center overflow-hidden">
              <img id="user-icon" src="https://placehold.co/100" alt="User" class="w-full h-full object-cover">
            </div>
          </div>
          <h3 id="user-name-display" class="font-bold text-gray-800">ゲスト様</h3>
        </div>

        <h3 class="font-bold text-gray-700 mb-3">予約履歴 / 確認</h3>
        <div id="reservation-history" class="space-y-3">
          <div class="flex justify-center py-8 text-enji"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        </div>
      </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-50">
      <div class="max-w-md mx-auto flex justify-around items-center h-16">
        <button onclick="switchTab('home')" id="nav-home"
          class="flex flex-col items-center justify-center w-full h-full text-enji transition-colors">
          <i class="fas fa-calendar-plus text-xl mb-1"></i>
          <span class="text-xs font-medium">予約する</span>
        </button>
        <button onclick="switchTab('mypage')" id="nav-mypage"
          class="flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors">
          <i class="fas fa-clipboard-list text-xl mb-1"></i>
          <span class="text-xs font-medium">確認/キャンセル</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- Loading Overlay -->
  <div id="loading" class="fixed inset-0 bg-white/80 flex justify-center items-center z-50 hidden">
    <div class="text-enji"><i class="fas fa-spinner fa-spin fa-3x"></i></div>
  </div>

  <!-- Reservation Detail Modal -->
  <div id="reservation-modal"
    class="fixed inset-0 bg-black/50 flex justify-center items-center z-50 hidden p-4 animate-fade-in">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-sm overflow-hidden">
      <div class="bg-enji text-white p-4 flex justify-between items-center">
        <h3 class="font-bold text-lg">予約詳細</h3>
        <button onclick="closeModal()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="text-xs text-gray-400 block">日時</label>
          <p id="modal-date" class="font-bold text-gray-800 text-lg"></p>
        </div>
        <div>
          <label class="text-xs text-gray-400 block">メニュー</label>
          <p id="modal-menu" class="font-bold text-gray-800"></p>
        </div>
        <div class="pt-4 border-t border-gray-100">
          <button id="modal-cancel-btn"
            class="w-full border border-red-500 text-red-500 font-bold py-3 rounded-lg hover:bg-red-50 transition-colors">予約をキャンセルする</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyluNEbWCZZsiQOHoo9A8bqvZwpFJ8VcE4ix-gxrAYkxS5kKxzKK6svOzE3jd2N5rPI/exec";
    const LIFF_ID = "2008591418-6eRNAepa";

    // State
    let state = {
      user: null,
      menu: null,
      date: null,
      time: null,
      currentTab: 'home'
    };

    // Initialization
    window.onload = async () => {
      // Localhost Mock
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        state.user = { userId: 'mock_user', displayName: 'Guest User', pictureUrl: 'https://placehold.co/100' };
        updateUserDisplay();
        loadMenus();
        return;
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        state.user = profile;
        updateUserDisplay();
        loadMenus();
      } catch (err) {
        console.error('LIFF Init Error', err);
        alert('LIFF Error: ' + err.message);
      }
    };

    function updateUserDisplay() {
      if (state.user) {
        document.getElementById('user-name-display').innerText = state.user.displayName + '様';
        if (state.user.pictureUrl) {
          document.getElementById('user-icon').src = state.user.pictureUrl;
        }
      }
    }

    // Navigation
    window.switchTab = (tab) => {
      state.currentTab = tab;

      // Toggle Views
      document.getElementById('home-view').classList.toggle('hidden', tab !== 'home');
      document.getElementById('home-view').classList.toggle('block', tab === 'home');
      document.getElementById('mypage-view').classList.toggle('hidden', tab !== 'mypage');
      document.getElementById('mypage-view').classList.toggle('block', tab === 'mypage');

      // Toggle Nav Active State
      const navHome = document.getElementById('nav-home');
      const navMypage = document.getElementById('nav-mypage');

      if (tab === 'home') {
        navHome.classList.add('text-enji');
        navHome.classList.remove('text-gray-400');
        navMypage.classList.add('text-gray-400');
        navMypage.classList.remove('text-enji');
        // If returning to home, ensure calendar is init
        if (!document.getElementById('calendar-grid').hasChildNodes()) initCalendar();
      } else {
        navMypage.classList.add('text-enji');
        navMypage.classList.remove('text-gray-400');
        navHome.classList.add('text-gray-400');
        navHome.classList.remove('text-enji');
        loadHistory();
      }
    };

    window.goBack = (stepId) => {
      document.getElementById('step-date').classList.add('hidden');
      document.getElementById('step-confirm').classList.add('hidden');
      document.getElementById('step-menu').classList.add('hidden');
      document.getElementById(stepId).classList.remove('hidden');
    };

    // Logic
    async function loadMenus() {
      const container = document.getElementById('menu-list');
      try {
        let menus = [];
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          menus = [
            { id: '1', name: 'フェイシャル基本コース', minutes: 60, price: 8000 },
            { id: '2', name: '全身アロマオイル', minutes: 90, price: 12000 },
            { id: '3', name: 'クイックマッサージ', minutes: 30, price: 4000 }
          ];
        } else {
          const res = await fetch(`${GAS_API_URL}?action=getMenus`);
          menus = await res.json();
        }

        container.innerHTML = menus.map(menu => `
          <div onclick='selectMenu(${JSON.stringify(menu)})' class="bg-white shadow-sm border border-gray-100 p-4 rounded-xl cursor-pointer hover:border-enji transition-all active:scale-95">
            <div class="flex justify-between items-center">
              <div>
                <h3 class="font-bold text-gray-800">${menu.name}</h3>
                <p class="text-sm text-gray-400 mt-1"><i class="far fa-clock"></i> ${menu.minutes}分</p>
              </div>
              <div class="text-enji font-bold text-lg">¥${menu.price.toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="text-center text-red-400">メニュー読み込みエラー</div>';
      }
    }

    window.selectMenu = (menu) => {
      state.menu = menu;
      document.getElementById('step-menu').classList.add('hidden');
      document.getElementById('step-date').classList.remove('hidden');
      state.date = null;
      state.time = null;
      document.getElementById('time-slots-container').classList.add('hidden');
      initCalendar();
    };

    // Calendar
    let currentMonth = new Date();

    function initCalendar() {
      document.getElementById('prev-month').onclick = () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        renderCalendar();
      };
      document.getElementById('next-month').onclick = () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        renderCalendar();
      };
      renderCalendar();
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      document.getElementById('calendar-title').innerText = `${year}年 ${month + 1}月`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      for (let i = 0; i < firstDay.getDay(); i++) {
        grid.appendChild(document.createElement('div'));
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        const dateStr = `${year}/${String(month + 1).padStart(2, '0')}/${String(d).padStart(2, '0')}`;

        const btn = document.createElement('button');
        btn.className = "h-10 w-full rounded-lg flex items-center justify-center text-sm font-medium transition-colors relative";

        if (date < today) {
          btn.classList.add('text-gray-300', 'cursor-not-allowed');
          btn.innerText = d;
        } else {
          btn.classList.add('hover:bg-enji', 'hover:text-white', 'text-gray-700');
          if (state.date === dateStr) {
            btn.classList.add('bg-enji', 'text-white');
          }
          btn.innerText = d;
          btn.onclick = () => selectDate(dateStr);
        }
        grid.appendChild(btn);
      }
    }

    async function selectDate(dateStr) {
      state.date = dateStr;
      renderCalendar();

      const container = document.getElementById('time-slots');
      const wrapper = document.getElementById('time-slots-container');

      wrapper.classList.remove('hidden');
      container.innerHTML = '<div class="col-span-3 text-center text-enji"><i class="fas fa-spinner fa-spin"></i></div>';

      try {
        let slots = [];
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          // Mock slots
          slots = ['10:00', '11:00', '14:00', '16:00'];
        } else {
          const res = await fetch(`${GAS_API_URL}?action=getSlots&date=${dateStr}&minutes=${state.menu.minutes}`);
          slots = await res.json();
        }

        container.innerHTML = '';
        if (slots.length === 0) {
          container.innerHTML = '<div class="col-span-3 text-center text-sm text-gray-400">空き枠がありません</div>';
          return;
        }

        slots.forEach(time => {
          const btn = document.createElement('button');
          btn.className = "py-2 border border-gray-300 rounded-lg text-sm hover:bg-enji hover:border-enji hover:text-white transition-colors";
          btn.innerText = time;
          btn.onclick = () => selectTime(time);
          container.appendChild(btn);
        });
      } catch (e) {
        container.innerHTML = '<div class="col-span-3 text-red-400 text-xs text-center">エラー</div>';
      }
    }

    function selectTime(time) {
      state.time = time;
      document.getElementById('step-date').classList.add('hidden');
      document.getElementById('step-confirm').classList.remove('hidden');

      document.getElementById('confirm-menu').innerText = state.menu.name;
      document.getElementById('confirm-date').innerText = state.date;
      document.getElementById('confirm-time').innerText = state.time;
    }

    window.submitReservation = async () => {
      const name = document.getElementById('user-name-input').value;
      if (!name) return alert('お名前を入力してください');

      document.getElementById('loading').classList.remove('hidden');
      try {
        const payload = {
          userId: state.user.userId,
          name: name,
          menuName: state.menu.name,
          menuMinutes: state.menu.minutes,
          date: state.date,
          time: state.time
        };

        let result = { status: 'success' };
        if (!(location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
          const res = await fetch(GAS_API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          result = await res.json();
        } else {
          await new Promise(r => setTimeout(r, 1000)); // Mock delay
        }

        if (result.status === 'success') {
          alert('予約が完了しました！');
          switchTab('mypage');
        } else {
          alert('エラー: ' + result.message);
        }
      } catch (e) {
        alert('通信エラー');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    };

    async function loadHistory() {
      const container = document.getElementById('reservation-history');
      container.innerHTML = '<div class="flex justify-center py-8 text-enji"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

      try {
        let history = [];
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          history = [
            { id: 'mock1', date: '2023/12/01', time: '10:00', menu: 'フェイシャル基本コース' }
          ];
        } else {
          const res = await fetch(`${GAS_API_URL}?action=getHistory&userId=${state.user.userId}`);
          history = await res.json();
        }

        if (history.length === 0) {
          container.innerHTML = `<div class="text-center text-gray-400 py-8">予約履歴はありません</div>`;
          return;
        }

        container.innerHTML = history.map(item => `
          <div onclick='showReservationDetails(${JSON.stringify(item)})' class="bg-white shadow-sm border-l-4 border-enji p-4 rounded-r-lg cursor-pointer active:bg-gray-50 transition-colors">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-bold text-gray-800 mb-1">${item.date} ${item.time}</div>
                <div class="text-sm text-gray-600">${item.menu}</div>
              </div>
              <div class="text-gray-400"><i class="fas fa-chevron-right"></i></div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        container.innerHTML = `<div class="text-center text-red-400 py-8">読み込みエラー</div>`;
      }
    }

    window.showReservationDetails = (item) => {
      document.getElementById('modal-date').innerText = `${item.date} ${item.time}`;
      document.getElementById('modal-menu').innerText = item.menu;

      const cancelBtn = document.getElementById('modal-cancel-btn');
      cancelBtn.onclick = () => {
        cancelReservation(item.id);
        closeModal();
      };

      document.getElementById('reservation-modal').classList.remove('hidden');
    };

    window.closeModal = () => {
      document.getElementById('reservation-modal').classList.add('hidden');
    };

    window.cancelReservation = async (reservationId) => {
      if (!confirm('本当にキャンセルしますか？')) return;

      document.getElementById('loading').classList.remove('hidden');
      try {
        let result = { status: 'success' };
        if (!(location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
          const payload = { action: 'cancel', userId: state.user.userId, reservationId: reservationId };
          const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
          result = await res.json();
        } else {
          await new Promise(r => setTimeout(r, 1000));
        }

        if (result.status === 'success') {
          alert('キャンセルしました');
          loadHistory();
        } else {
          alert('エラー: ' + result.message);
        }
      } catch (e) {
        alert('通信エラー');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    };
  </script>
</body>

</html>