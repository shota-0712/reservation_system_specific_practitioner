# マルチテナント予約システム アーキテクチャ設計書

**バージョン**: 2.1.0
**最終更新日**: 2026-01-31
**ステータス**: Active

## 関連ドキュメント

- [GLOSSARY.md](./GLOSSARY.md) - 用語定義
- [API_DESIGN.md](./API_DESIGN.md) - API 設計
- [AUTH_DESIGN.md](./AUTH_DESIGN.md) - 認証・認可設計
- [SECURITY_AND_URL_DESIGN.md](./SECURITY_AND_URL_DESIGN.md) - セキュリティ/URL設計
- [DATABASE_INDEXES.md](./DATABASE_INDEXES.md) - DBインデックス設計
- [FIRESTORE_SECURITY_RULES.md](./FIRESTORE_SECURITY_RULES.md) - RLS/DBアクセス設計（ファイル名は旧称）
- [ENTERPRISE_ARCHITECTURE.md](./ENTERPRISE_ARCHITECTURE.md) - エンタープライズ規模の設計

---

## 1. エグゼクティブサマリー

### 1.1 目的
単一店舗向け予約システムを、**マルチテナント・マルチ店舗対応のSaaS**へ拡張する。
LINEミニアプリ（顧客）とWeb管理画面（運営/店舗）を中心に、
大規模チェーンでも運用できる基盤にする。

### 1.2 ターゲット顧客
- 年商 **3〜5億円規模** の複数店舗サロン運営会社
- 3〜50店舗規模（将来は100+店舗も想定）
- 本社/経営層が **全店舗を横断管理** したいニーズ

### 1.3 主要な設計判断
| 項目 | 旧設計 | 新設計（目標） |
|------|--------|----------------|
| メインDB | Firestore | **Cloud SQL (PostgreSQL)** |
| テナント分離 | アプリ側のみ | **RLS（Row Level Security）でDB強制** |
| 予約の競合防止 | アプリチェック | **排他制約（Exclusion Constraint）** |
| 顧客向けUI | LIFF/LINE | **LINEミニアプリ（店舗別URL）** |
| 管理画面 | 単一店舗 | **テナント内の複数店舗を管理** |

---

## 2. システムアーキテクチャ全体像

### 2.1 アーキテクチャ概要図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              クライアント層                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  顧客: LINEミニアプリ  ──>  予約/マイページ                                  │
│  管理者: Admin Web      ──>  店舗管理/予約管理/分析                          │
│  本社: HQ Dashboard      ──>  店舗横断KPI/設定/権限                          │
└─────────────────────────────────────────────────────────────────────────────┘
                │                                  │
                └──────────────────┬───────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API/サービス層                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  Cloud Run (Express v2)                                                      │
│   - テナント/店舗解決ミドルウェア                                            │
│   - 認証/認可 (Firebase Auth + LINE Auth)                                    │
│   - ビジネスロジック（予約/顧客/分析/通知）                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  データ層                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Cloud SQL (PostgreSQL)                                                      │
│   - tenants / stores / reservations / customers / admins ...                 │
│   - RLSによるテナント分離                                                    │
│   - 排他制約による二重予約防止                                                │
│  Cloud Storage (画像)                                                       │
│  BigQuery (分析/BI) ※拡張                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               外部連携/通知                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  LINE Messaging API / Google Calendar / SalonBoard / Stripe / SendGrid       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. テナント/店舗モデル

### 3.1 ドメイン階層

```
Tenant（企業）
 ├─ Store（店舗）
 │   ├─ Practitioner（スタッフ）
 │   ├─ Reservation（予約）
 │   └─ Settings（店舗設定）
 └─ Admin（管理者/権限）
```

### 3.2 識別子設計

| 種別 | 用途 | 例 | 備考 |
|------|------|----|------|
| tenant_id | 内部ID | `UUID` | DBの主キー
| tenant_slug | 管理画面URL | `salon-group-a` | 人間が読める
| store_id | 内部ID | `UUID` | 店舗主キー
| store_code | 顧客向けURL | `a7x9m2k5` | 推測困難（8-10文字）

**重要**: 顧客向けURLは `store_code` を使用し、推測を困難にする。
（詳細は [SECURITY_AND_URL_DESIGN.md](./SECURITY_AND_URL_DESIGN.md)）

### 3.3 DBレベルの分離モデル

**Pool + RLS（Row Level Security）** を採用。
全テナントが同一テーブルを共有し、`tenant_id` をキーに分離する。

- **メリット**: 高い運用効率・低コスト・スケールしやすい
- **実装**: `set_tenant()` で `app.current_tenant` を設定してRLSを強制

---

## 4. 主要フロー

### 4.1 顧客予約フロー（LINEミニアプリ）

1. 顧客が `https://reserve.example.com/{store_code}` にアクセス
2. APIが `store_code` から **store_id + tenant_id** を解決
3. リクエスト開始時に `set_tenant(tenant_id)` を実行
4. 予約作成時に `reservations` へ INSERT
5. **排他制約**が衝突を防止（重複予約は409）

### 4.2 管理者フロー（Admin Dashboard）

1. 管理者が Firebase Auth でログイン
2. APIは JWT から管理者権限を取得
3. ルート ` /api/v1/{tenantKey}/admin/... ` でテナントを決定
   - tenantKey = `tenant_id` or `tenant_slug`
4. 店舗単位操作は `store_id` を指定（ヘッダー or クエリ）

---

## 5. マルチ店舗運用の設計ポイント

### 5.1 店舗横断の管理
- **HQダッシュボード**: 全店舗のKPI/売上/予約統計
- **店舗フィルター**: store_id を指定して絞り込み
- **権限**: `admins.role` + `admins.store_ids` によりアクセス制御

### 5.2 店舗別の公開情報
- LINEミニアプリ URL は **店舗ごと** に分離
- 店舗の営業時間・定休日・予約ルールは `stores` / `settings` に保持

---

## 6. 実装指針（Cloud SQL 前提）

- **DBスキーマ**: `database/schema/001_initial_schema.sql` に準拠（RLS + 排他制約）
- **Tenant解決**: `tenant_id` / `tenant_slug` / `store_code` のいずれかから解決
- **店舗コンテキスト**:
  - `store_code` でアクセスされた場合は `store_id` を自動解決
  - 管理画面は `X-Store-Id` または `?storeId=` を明示指定
- **RLSセッション**: `set_tenant(tenant_id)` をリクエスト開始時に必ず実行

---

## 7. 成功条件（SLO）

- **予約の重複率**: 0%（排他制約により保証）
- **テナントデータ漏洩**: 0件（RLS + アプリ認可）
- **99.9% 可用性**（Cloud Run + Cloud SQL HA構成）
