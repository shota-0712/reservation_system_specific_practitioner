# LINEミニアプリ マルチテナント設計書

> **重要**: 本設計書は **LINEミニアプリ**（認証済みミニアプリ）を前提とする。
> サービスメッセージ（無料通知）を活用し、予約リマインドを高い到達率で配信する。

**バージョン**: 2.1.0
**最終更新日**: 2026-01-31
**ステータス**: Active

---

## 1. 前提と方針

### 1.1 LINEミニアプリの採用理由
- 友だち追加不要で予約が可能
- サービスメッセージが利用可能（ブロック不可）
- サロンごとのブランド体験を担保

### 1.2 テナント/店舗の考え方
- **テナント = 会社/グループ**
- **店舗 = サロン**
- 顧客向けURLは **店舗単位** で分離（store_code）

---

## 2. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              顧客（LINE）                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  LINE App → ミニアプリ（store_codeごとに起動）                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API（Cloud Run）                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  - テナント/店舗解決
│  - LINE認証
│  - 予約/顧客/メニュー処理
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Cloud SQL（PostgreSQL）                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  tenants / stores / customers / reservations ... (RLS適用)                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. URL設計

### 3.1 顧客向けURL

```
https://reserve.example.com/{store_code}
```

- `store_code` は推測困難な文字列（8〜10文字）
- 店舗単位でユニーク

### 3.2 API

```
https://api.example.com/api/v1/{tenantKey}/...
- tenantKey = store_code / tenant_id / tenant_slug
```

---

## 4. 認証フロー（顧客）

1. ミニアプリ初期化
   - `GET /{tenantKey}/auth/config` で LIFF/ブランド情報を取得
2. LINE ID Token を取得
3. `POST /{tenantKey}/auth/line` に送信
4. Firebase Custom Token を発行
5. 以降のAPIは Firebase ID Token で認証

---

## 5. 店舗別の体験設計

- **店舗ごとのブランディング**
  - `tenants.branding_*` を利用
- **店舗ごとの営業時間/予約ルール**
  - `stores.business_hours` / `settings` を参照
- **店舗ごとの予約履歴/カルテ**
  - `store_code` から `store_id` を解決し、`reservations.store_id` に紐付け
  - マイページは `store_id` 単位で履歴を表示

---

## 6. 通知設計

- 予約確定通知
- 前日/当日リマインド
- キャンセル通知

**送信ルール**
- テナントのLINE設定（channel access token）を利用
- 店舗ごとのテンプレートは `settings.message_templates` で管理
