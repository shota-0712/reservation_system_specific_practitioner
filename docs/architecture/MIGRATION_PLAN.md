# 移行計画書

**バージョン**: 2.1.0
**最終更新日**: 2026-01-31
**ステータス**: Draft

---

## 1. 目的

既存システムから **Cloud SQL + RLS** ベースのマルチテナント構成へ移行する。
（既にCloud SQLが稼働している場合は、**スキーマ移行とAPI移行**に注力する）

---

## 2. フェーズ

### Phase 0: 準備（1週間）
- Cloud SQLインスタンス作成
- スキーマ適用（RLS/排他制約含む）
- **v2.1スキーマ移行**（store_code移動、予約ステータス整理）
- 接続/監視/バックアップ設定

### Phase 1: データ移行（必要な場合）
- 既存データ抽出（Sheets/旧DBなど）
- 変換・正規化
- PostgreSQLへ一括投入
- データ整合性チェック

### Phase 2: API移行（2週間）
- Repository層をSQL対応に移行
- RLSセッション設定ミドルウェア導入
- 予約排他制約エラーの変換

### Phase 3: 並行運用（1週間）
- 旧/新システムのデータ比較
- 負荷テスト

### Phase 4: 本番切替
- Blue/Greenデプロイ
- 監視とロールバック手順

---

## 3. 成功条件

- 二重予約発生率 0%
- テナント越境アクセス 0件
- 本番切替後の障害なし
